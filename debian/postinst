#!/bin/bash
set -e

# Source debconf library
. /usr/share/debconf/confmodule

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# Function to detect current IP (fallback)
detect_current_ip() {
    local current_ip=$(ip route get 1.1.1.1 2>/dev/null | grep -oP 'src \K[0-9.]+' | head -1)
    if [ -z "$current_ip" ]; then
        current_ip=$(ip -4 addr show | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep -v '127.0.0.1' | head -1)
    fi
    echo "${current_ip:-127.0.0.1}"
}

# Function to get configuration from debconf or environment
get_configuration() {
    # First try environment variables (for automated installation)
    if [ -n "$JOBLET_SERVER_IP" ]; then
        JOBLET_SERVER_ADDRESS="$JOBLET_SERVER_IP"
        print_info "Using server address from environment: $JOBLET_SERVER_ADDRESS"
    else
        # Try debconf
        if command -v db_get >/dev/null 2>&1; then
            db_get joblet/server_address || true
            JOBLET_SERVER_ADDRESS="$RET"

            db_get joblet/server_port || true
            JOBLET_SERVER_PORT="$RET"

            db_get joblet/additional_names || true
            JOBLET_ADDITIONAL_NAMES="$RET"
        fi
    fi

    # Use detected IP as ultimate fallback
    if [ -z "$JOBLET_SERVER_ADDRESS" ]; then
        JOBLET_SERVER_ADDRESS=$(detect_current_ip)
        print_warning "No server address configured, using detected IP: $JOBLET_SERVER_ADDRESS"
    fi

    # Set defaults
    JOBLET_SERVER_PORT=${JOBLET_SERVER_PORT:-50051}
    JOBLET_ADDITIONAL_NAMES=${JOBLET_ADDITIONAL_NAMES:-}
}

# Function to generate and embed certificates
generate_and_embed_certificates() {
    print_info "Generating certificates and embedding them in config files..."

    # Export variables for the certificate generation script
    export JOBLET_SERVER_ADDRESS
    export JOBLET_ADDITIONAL_NAMES
    export JOBLET_MODE="package-install"  # Special mode for package installation

    # Ensure scripts directory exists and has correct permissions
    if [ -d "/opt/joblet/scripts" ]; then
        chmod 755 /opt/joblet/scripts
        chmod 644 /opt/joblet/scripts/*.yml 2>/dev/null || true
    fi

    # Run the embedded certificate generation script
    if [ -x /usr/local/bin/certs_gen_embedded.sh ]; then
        /usr/local/bin/certs_gen_embedded.sh
    else
        print_error "Certificate generation script not found or not executable"
        return 1
    fi

    print_success "Certificates generated and embedded successfully"
}

case "$1" in
    configure)
        print_info "ðŸ”§ Configuring Joblet Service with Embedded Certificates..."
        echo

        # Set basic permissions first
        chown -R root:root /opt/joblet
        chmod 755 /opt/joblet
        chmod 755 /opt/joblet/joblet
        chmod 755 /opt/joblet/rnx
        chmod 755 /opt/joblet/scripts
        chmod 644 /opt/joblet/scripts/joblet-config-template.yml
        chmod 644 /opt/joblet/scripts/rnx-config-template.yml
        chmod +x /usr/local/bin/certs_gen_embedded.sh

        # Create config directory
        mkdir -p /opt/joblet/config
        chmod 700 /opt/joblet/config  # Restricted since it will contain private keys

        # Create symlinks
        if [ ! -L /usr/bin/rnx ]; then
            ln -sf /opt/joblet/rnx /usr/bin/rnx
        fi

        # Get configuration from debconf/environment
        get_configuration

        print_info "Configuration Summary:"
        echo "  Server Address: $JOBLET_SERVER_ADDRESS"
        echo "  Server Port: $JOBLET_SERVER_PORT"
        echo "  Additional Names: ${JOBLET_ADDITIONAL_NAMES:-none}"
        echo

        # Generate certificates and embed them in config files
        generate_and_embed_certificates

        # Set secure permissions on config files (they now contain private keys)
        chmod 600 /opt/joblet/config/joblet-config.yml  # Server config has private keys
        chmod 600 /opt/joblet/config/rnx-config.yml     # Client config has private keys

        # Create log directory
        mkdir -p /var/log/joblet
        chown root:root /var/log/joblet
        chmod 755 /var/log/joblet

        # Setup cgroup delegation
        if [ -d /sys/fs/cgroup ]; then
            print_info "Setting up cgroup delegation..."
            mkdir -p /sys/fs/cgroup/joblet.slice
            echo "+cpu +memory +io +pids" > /sys/fs/cgroup/joblet.slice/cgroup.subtree_control 2>/dev/null || true
        fi

        # Enable systemd service
        systemctl daemon-reload
        systemctl enable joblet.service

        echo
        print_success "Joblet service installed successfully with embedded certificates!"
        echo

        echo
        print_info "ðŸ“± Remote CLI Setup:"
        echo "  Copy /opt/joblet/config/rnx-config.yml to remote machines"
        echo "  Remote usage: rnx --config=rnx-config.yml list"
        echo
        ;;
esac

exit 0