#!/bin/bash
set -e

case "$1" in
    configure)
        echo "Configuring worker service..."

        # Set ownership and permissions for /opt/worker structure
        chown -R root:root /opt/worker
        chmod 755 /opt/worker

        # Make binaries executable - BOTH in /opt/worker/
        chmod 755 /opt/worker/worker
        chmod 755 /opt/worker/worker-cli

        # Config file permissions
        chmod 644 /opt/worker/config/config.yml

        # Make cert generation script executable
        chmod +x /usr/local/bin/certs_gen.sh

        # Create symlinks for easier access
        if [ ! -L /usr/bin/worker ]; then
            ln -sf /opt/worker/worker-cli /usr/bin/worker
        fi
        if [ ! -L /usr/bin/worker-cli ]; then
            ln -sf /opt/worker/worker-cli /usr/bin/worker-cli
        fi

        # Generate certificates with proper root ownership
        echo "Generating SSL certificates..."
        /usr/local/bin/certs_gen.sh

        # Ensure certificates have secure permissions (root only)
        if [ -d /opt/worker/certs ]; then
            chown -R root:root /opt/worker/certs
            chmod 700 /opt/worker/certs
            chmod 600 /opt/worker/certs/*-key.pem 2>/dev/null || true
            chmod 644 /opt/worker/certs/*-cert.pem 2>/dev/null || true
        fi

        # Create necessary directories
        mkdir -p /var/log/worker
        chown root:root /var/log/worker
        chmod 755 /var/log/worker

        # Setup cgroup delegation
        if [ -d /sys/fs/cgroup ]; then
            echo "Setting up cgroup delegation..."
            mkdir -p /sys/fs/cgroup/worker.slice
            echo "+cpu +memory +io +pids" > /sys/fs/cgroup/worker.slice/cgroup.subtree_control 2>/dev/null || true
        fi

        # Reload systemd and enable service
        systemctl daemon-reload
        systemctl enable worker.service

        echo "✅ Worker service installed successfully!"
        echo ""
        echo "📁 Installation layout:"
        echo "   Daemon:      /opt/worker/worker"
        echo "   CLI:         /opt/worker/worker-cli"
        echo "   Config:      /opt/worker/config/config.yml"
        echo "   Certificates: /opt/worker/certs/"
        echo "   Symlinks:    /usr/bin/worker -> /opt/worker/worker-cli"
        echo "               /usr/bin/worker-cli -> /opt/worker/worker-cli"
        echo ""
        echo "🚀 To start: sudo systemctl start worker"
        echo "📊 To check status: sudo systemctl status worker"
        echo "💻 CLI usage: worker --help"
        ;;
esac

exit 0