#!/bin/bash
set -e

# Source debconf library
. /usr/share/debconf/confmodule

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

# Function to detect current IP (fallback)
detect_current_ip() {
    local current_ip=$(ip route get 1.1.1.1 2>/dev/null | grep -oP 'src \K[0-9.]+' | head -1)
    if [ -z "$current_ip" ]; then
        current_ip=$(ip -4 addr show | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep -v '127.0.0.1' | head -1)
    fi
    echo "${current_ip:-127.0.0.1}"
}

# Function to get configuration from debconf or environment
get_configuration() {
    # First try environment variables (for automated installation)
    if [ -n "$WORKER_SERVER_IP" ]; then
        WORKER_SERVER_ADDRESS="$WORKER_SERVER_IP"
        print_info "Using server address from environment: $WORKER_SERVER_ADDRESS"
    else
        # Try debconf
        if command -v db_get >/dev/null 2>&1; then
            db_get worker/server_address || true
            WORKER_SERVER_ADDRESS="$RET"

            db_get worker/server_port || true
            WORKER_SERVER_PORT="$RET"

            db_get worker/additional_names || true
            WORKER_ADDITIONAL_NAMES="$RET"
        fi
    fi

    # Use detected IP as ultimate fallback
    if [ -z "$WORKER_SERVER_ADDRESS" ]; then
        WORKER_SERVER_ADDRESS=$(detect_current_ip)
        print_warning "No server address configured, using detected IP: $WORKER_SERVER_ADDRESS"
    fi

    # Set defaults
    WORKER_SERVER_PORT=${WORKER_SERVER_PORT:-50051}
    WORKER_ADDITIONAL_NAMES=${WORKER_ADDITIONAL_NAMES:-}
}

# Function to generate and embed certificates
generate_and_embed_certificates() {
    print_info "Generating certificates and embedding them in config files..."

    # Export variables for the certificate generation script
    export WORKER_SERVER_ADDRESS
    export WORKER_ADDITIONAL_NAMES
    export WORKER_MODE="package-install"  # Special mode for package installation

    # Ensure scripts directory exists and has correct permissions
    if [ -d "/opt/worker/scripts" ]; then
        chmod 755 /opt/worker/scripts
        chmod 644 /opt/worker/scripts/*.yml 2>/dev/null || true
    fi

    # Run the embedded certificate generation script
    if [ -x /usr/local/bin/certs_gen_embedded.sh ]; then
        /usr/local/bin/certs_gen_embedded.sh
    else
        print_error "Certificate generation script not found or not executable"
        return 1
    fi

    print_success "Certificates generated and embedded successfully"
}

case "$1" in
    configure)
        print_info "üîß Configuring Worker Service with Embedded Certificates..."
        echo

        # Set basic permissions first
        chown -R root:root /opt/worker
        chmod 755 /opt/worker
        chmod 755 /opt/worker/worker
        chmod 755 /opt/worker/worker-cli
        chmod 755 /opt/worker/scripts
        chmod 644 /opt/worker/scripts/server-config-template.yml
        chmod 644 /opt/worker/scripts/client-config-template.yml
        chmod +x /usr/local/bin/certs_gen.sh

        # Create config directory
        mkdir -p /opt/worker/config
        chmod 700 /opt/worker/config  # Restricted since it will contain private keys

        # Create symlinks
        if [ ! -L /usr/bin/worker-cli ]; then
            ln -sf /opt/worker/worker-cli /usr/bin/worker-cli
        fi

        # Get configuration from debconf/environment
        get_configuration

        print_info "Configuration Summary:"
        echo "  Server Address: $WORKER_SERVER_ADDRESS"
        echo "  Server Port: $WORKER_SERVER_PORT"
        echo "  Additional Names: ${WORKER_ADDITIONAL_NAMES:-none}"
        echo

        # Generate certificates and embed them in config files
        generate_and_embed_certificates

        # Set secure permissions on config files (they now contain private keys)
        chmod 600 /opt/worker/config/server-config.yml  # Server config has private keys
        chmod 600 /opt/worker/config/client-config.yml  # Client config has private keys

        # Create log directory
        mkdir -p /var/log/worker
        chown root:root /var/log/worker
        chmod 755 /var/log/worker

        # Setup cgroup delegation
        if [ -d /sys/fs/cgroup ]; then
            print_info "Setting up cgroup delegation..."
            mkdir -p /sys/fs/cgroup/worker.slice
            echo "+cpu +memory +io +pids" > /sys/fs/cgroup/worker.slice/cgroup.subtree_control 2>/dev/null || true
        fi

        # Enable systemd service
        systemctl daemon-reload
        systemctl enable worker.service

        echo
        print_success "Worker service installed successfully with embedded certificates!"
        echo
        print_info "üìÅ Installation Summary:"
        echo "  Server Address: $WORKER_SERVER_ADDRESS"
        echo "  Server Port: $WORKER_SERVER_PORT"
        echo "  Server Config: /opt/worker/config/server-config.yml (with embedded certs)"
        echo "  Client Config: /opt/worker/config/client-config.yml (with embedded certs)"
        echo "  üîê All certificates are embedded in configuration files"
        echo "  üóëÔ∏è  No separate certificate files to manage"
        echo
        print_info "üöÄ Next Steps:"
        echo "  1. Start service: sudo systemctl start worker"
        echo "  2. Check status: sudo systemctl status worker"
        echo "  3. View logs: sudo journalctl -u worker -f"
        echo "  4. Test CLI: worker-cli list"
        echo "  5. Use CLI with config: worker-cli --config=/opt/worker/config/client-config.yml list"
        echo
        print_info "üì± Remote CLI Setup:"
        echo "  Copy /opt/worker/config/client-config.yml to remote machines"
        echo "  Remote usage: worker-cli --config=client-config.yml list"
        echo
        print_info "üîß To reconfigure later:"
        echo "  sudo dpkg-reconfigure worker"
        echo "  Or manually: WORKER_SERVER_ADDRESS='new-ip' /usr/local/bin/certs_gen_embedded.sh"
        echo
        ;;
esac

exit 0